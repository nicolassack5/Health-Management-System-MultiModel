<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Paciente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        #dashboard-screen, #confirmation-modal { display: none; }
        #loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1e40af; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .login-tab.active { border-bottom: 2px solid #1d4ed8; color: #1d4ed8; }
        .login-tab { border-bottom: 2px solid transparent; }
    </style>
</head>
<body class="bg-gray-100 h-screen">

    <div id="login-screen" class="flex items-center justify-center h-full">
        <div class="p-8 bg-white rounded-lg shadow-xl w-96">
            <div class="flex border-b mb-6">
                <button id="tab-btn-login" class="login-tab active w-1/2 py-2 font-semibold">Ingresar</button>
                <button id="tab-btn-register" class="login-tab w-1/2 py-2 font-semibold text-gray-500">Registrarse</button>
            </div>
            <div id="login-pane">
                <form id="login-form">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">VidaSana (Paciente)</h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="username">Usuario</label>
                        <input id="username" type="text" value="ljuan" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Contraseña</label>
                        <input id="password" type="password" value="pass123" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm mb-4 hidden"></div>
                    <button type="submit" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded w-full">Ingresar</button>
                </form>
            </div>
            <div id="register-pane" class="hidden">
                <form id="register-form">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Crear Cuenta Paciente</h2>
                    <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <input id="username-reg" type="text" placeholder="* Nombre de Usuario" class="shadow-sm border rounded w-full py-2 px-3" required>
                        <input id="password-reg" type="password" placeholder="* Contraseña" class="shadow-sm border rounded w-full py-2 px-3" required>
                        <hr>
                        <input id="nombre-reg" type="text" placeholder="* Nombre Completo" class="shadow-sm border rounded w-full py-2 px-3" required>
                        <input id="dni-reg" type="text" placeholder="* DNI" class="shadow-sm border rounded w-full py-2 px-3" required>
                        <input id="email-reg" type="email" placeholder="* Email" class="shadow-sm border rounded w-full py-2 px-3" required>
                        <div>
                            <label class="text-sm text-gray-500">* Fecha de Nacimiento</label>
                            <input id="fecha-nac-reg" type="date" class="shadow-sm border rounded w-full py-2 px-3" required>
                        </div>
                        <input id="telefono-reg" type="tel" placeholder="Teléfono (ej: +54...)" class="shadow-sm border rounded w-full py-2 px-3">
                        <input id="direccion-reg" type="text" placeholder="Dirección" class="shadow-sm border rounded w-full py-2 px-3">
                        <input id="pais-reg" type="text" placeholder="País (ej: AR)" class="shadow-sm border rounded w-full py-2 px-3">
                        <select id="genero-reg" class="shadow-sm border rounded w-full py-2 px-3 text-gray-500">
                            <option value="">Seleccionar Género (Opcional)</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                            <option value="O">Otro</option>
                        </select>
                        <hr>
                        <input id="os-reg" type="text" placeholder="Obra Social (Opcional)" class="shadow-sm border rounded w-full py-2 px-3">
                        <input id="afiliado-reg" type="text" placeholder="N° de Afiliado (Opcional)" class="shadow-sm border rounded w-full py-2 px-3">
                    </div>
                    <div id="register-status" class="text-sm my-4 hidden"></div>
                    <button type="submit" class="bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-4 rounded w-full mt-4">Crear Cuenta</button>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="h-screen flex-col bg-gray-100">
        <header class="flex items-center justify-between p-4 bg-white border-b shadow-sm">
            <h1 class="text-2xl font-bold text-blue-800">VidaSana</h1>
            <div class="flex items-center space-x-4">
                <span class="text-gray-700 hidden sm:block">¡Hola, <span id="user-name" class="font-semibold"></span>!</span>
                <button id="logout-button" class="text-gray-500 hover:text-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>
        <main class="flex-1 flex flex-col p-6 overflow-hidden">
            <div class="flex-1 p-6 overflow-auto bg-white rounded-lg shadow-lg">
                <nav class="flex space-x-2 mb-6 border-b border-gray-200">
                    <button data-tab="perfil" class="tab-button flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-t-md border-b-2 border-blue-700 text-blue-800"><i data-lucide="user" class="w-4 h-4"></i><span>Mi Perfil</span></button>
                    <button data-tab="registrar" class="tab-button flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-t-md text-gray-500 hover:text-gray-700"><i data-lucide="edit" class="w-4 h-4"></i><span>Registrar Hábito</span></button>
                    <button data-tab="habitos" class="tab-button flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-t-md text-gray-500 hover:text-gray-700"><i data-lucide="line-chart" class="w-4 h-4"></i><span>Mis Hábitos</span></button>
                    <button data-tab="turnos" class="tab-button flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-t-md text-gray-500 hover:text-gray-700"><i data-lucide="calendar" class="w-4 h-4"></i><span>Sacar Turno</span></button>
                    <button data-tab="mis-turnos" class="tab-button flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-t-md text-gray-500 hover:text-gray-700"><i data-lucide="clock" class="w-4 h-4"></i><span>Mis Turnos</span></button>
                </nav>
                <div id="loading-spinner" class="mx-auto hidden"></div>
                <div id="content-error" class="text-red-500 hidden"></div>
                <div id="tab-content">
                    <div id="perfil-content" class="tab-pane"></div>
                    <div id="registrar-content" class="tab-pane hidden"></div>
                    <div id="habitos-content" class="tab-pane hidden"></div>
                    <div id="turnos-content" class="tab-pane hidden"></div>
                    <div id="mis-turnos-content" class="tab-pane hidden"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex flex-col items-center text-center">
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i data-lucide="alert-triangle" class="w-8 h-8 text-orange-500"></i>
                    </div>
                    <h3 id="modal-title" class="text-2xl font-semibold text-gray-800 mt-4"></h3>
                    <p id="modal-message" class="text-gray-600 mt-2"></p>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-8">
                    <button id="modal-btn-cancel" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">
                        Cancelar
                    </button>
                    <button id="modal-btn-confirm" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">
                        Sí, Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentToken = null;
        let currentUser = null; 
        let currentPacientePerfil = null; 

        // --- Selectores (Sin cambios) ---
        const loginScreen = document.getElementById('login-screen');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const userName = document.getElementById('user-name');
        const logoutButton = document.getElementById('logout-button');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const loadingSpinner = document.getElementById('loading-spinner');
        const contentError = document.getElementById('content-error');
        const tabBtnLogin = document.getElementById('tab-btn-login');
        const tabBtnRegister = document.getElementById('tab-btn-register');
        const loginPane = document.getElementById('login-pane');
        const registerPane = document.getElementById('register-pane');
        const registerForm = document.getElementById('register-form');
        const registerStatus = document.getElementById('register-status');
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalBtnConfirm = document.getElementById('modal-btn-confirm');
        const modalBtnCancel = document.getElementById('modal-btn-cancel');
        let modalConfirmCallback = null;

        // --- Lógica del Modal (Sin cambios) ---
        function showConfirmationModal(title, message, onConfirmCallback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmCallback = onConfirmCallback; 
            modal.style.display = 'flex';
            lucide.createIcons();
        }
        function hideModal() {
            modal.style.display = 'none';
            modalConfirmCallback = null;
        }
        modalBtnCancel.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
        modalBtnConfirm.addEventListener('click', () => {
            if (modalConfirmCallback) modalConfirmCallback();
            hideModal();
        });

        // --- Helper de API (Sin cambios) ---
        const fetchApi = async (url, options = {}) => {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            const res = await fetch(url, options);
            if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Error de API'); }
            return res.json();
        };

        // --- Login (Sin cambios) ---
        async function handleLogin(e) {
            e.preventDefault();
            loginError.classList.add('hidden');
            const formData = new URLSearchParams();
            formData.append('username', document.getElementById('username').value);
            formData.append('password', document.getElementById('password').value);
            try {
                const res = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData,
                });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail); }
                const tokenData = await res.json();
                currentToken = tokenData.access_token;
                localStorage.setItem('vidasana_token', currentToken);
                currentUser = await fetchApi(`${API_URL}/usuarios/me`);
                if (!currentUser.roles.includes("PACIENTE")) {
                    throw new Error("Acceso denegado. Este portal es solo para PACIENTES.");
                }
                await showDashboard();
            } catch (error) {
                console.error("Error en el login:", error);
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
                handleLogout();
            }
        }

        // --- Registro (Sin cambios) ---
        async function handleRegister(e) {
            e.preventDefault();
            registerStatus.classList.add('hidden');
            const body = {
                username: document.getElementById('username-reg').value,
                password: document.getElementById('password-reg').value,
                pii: {
                    nombre: document.getElementById('nombre-reg').value,
                    dni: document.getElementById('dni-reg').value,
                    email: document.getElementById('email-reg').value,
                    fecha_nac: document.getElementById('fecha-nac-reg').value,
                    telefono: document.getElementById('telefono-reg').value || null,
                    direccion: document.getElementById('direccion-reg').value || null,
                    pais: document.getElementById('pais-reg').value || null,
                    genero: document.getElementById('genero-reg').value || null
                },
                obra_social: document.getElementById('os-reg').value || null,
                numero_afiliado: document.getElementById('afiliado-reg').value || null
            };
            try {
                const res = await fetch(`${API_URL}/register/paciente`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail); }
                registerStatus.textContent = "¡Registro exitoso! Ahora puedes ingresar.";
                registerStatus.className = 'text-sm mb-4 text-green-600';
                registerStatus.classList.remove('hidden');
                registerForm.reset();
                switchLoginTabs('login');
            } catch (error) {
                console.error("Error en el registro:", error);
                registerStatus.textContent = error.message;
                registerStatus.className = 'text-sm mb-4 text-red-600';
                registerStatus.classList.remove('hidden');
            }
        }
        
        async function showDashboard() {
            userName.textContent = currentUser?.pii?.nombre || currentUser?.auth?.username;
            loginScreen.style.display = 'none';
            dashboardScreen.style.display = 'flex';
            await fetchDataForTab('perfil');
        }

        function handleLogout() {
            localStorage.removeItem('vidasana_token');
            currentToken = null; currentUser = null;
            loginScreen.style.display = 'flex';
            dashboardScreen.style.display = 'none';
        }

        // --- Carga de Datos (Sin cambios) ---
        async function fetchDataForTab(tabName) {
            if (!currentUser) return;
            const pacienteId = currentUser._id;
            const contentDiv = document.getElementById(`${tabName}-content`);
            contentDiv.innerHTML = ''; 
            loadingSpinner.classList.remove('hidden');
            contentError.classList.add('hidden');
            try {
                if (tabName === 'perfil') {
                    currentPacientePerfil = await fetchApi(`${API_URL}/paciente/${pacienteId}/perfil`);
                    renderPerfil(currentPacientePerfil, false); 
                } else if (tabName === 'registrar') {
                    renderFormHabito();
                } else if (tabName === 'habitos') {
                    const habitos = await fetchApi(`${API_URL}/paciente/${pacienteId}/habitos`);
                    renderHabitos(habitos);
                } else if (tabName === 'turnos') {
                    const medicos = await fetchApi(`${API_URL}/medicos`);
                    renderFormTurno(medicos);
                } else if (tabName === 'mis-turnos') { 
                    const turnos = await fetchApi(`${API_URL}/paciente/${pacienteId}/turnos`);
                    renderMisTurnos(turnos);
                }
            } catch (err) {
                console.error("Error fetching data:", err);
                contentError.textContent = `Error: ${err.message}`;
                contentError.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                lucide.createIcons();
            }
        }
        
        // --- (¡CORREGIDO!) Render Perfil ---
        function renderPerfil(perfil, isEditing = false) {
            const p = perfil.paciente || {};
            const pii = perfil.pii || {};
            const clinico = p.clinico || {};
            
            let html = '';
            const na = (val) => val || ''; // Para inputs
            const naView = (val, message) => val || (message ? `<span class="text-gray-500 font-normal">${message}</span>` : '<span class="text-gray-400">N/A</span>');
            const MENSAGES = {
                telefono: "Proporcionar un número de contacto",
                direccion: "Direccion no registrado (Agregar pais en editar perfil)",
                pais: "N/A",
                obra_social: "Agregar obra social en editar perfil",
                numero_afiliado: "Agregar numero de afiliado",
                grupo_sanguineo: "Informar Grupo Sanguineo",
                alergias: "Informar alergias para seguridad",
            };

            if (isEditing) {
                // --- MODO EDICIÓN ---
                html = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Editar Mi Perfil</h3>
                    </div>
                    <div id="perfil-save-status" class="text-sm my-2"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="md:col-span-2"><label class="text-sm font-medium text-gray-500">Dirección</label><input id="perfil-direccion" value="${na(pii.direccion)}" class="shadow-sm border rounded w-full py-2 px-3"></div>
                        <div><label class="text-sm font-medium text-gray-500">Teléfono</label><input id="perfil-telefono" value="${na(pii.telefono)}" class="shadow-sm border rounded w-full py-2 px-3"></div>
                        <div><label class="text-sm font-medium text-gray-500">País (ej: AR)</label><input id="perfil-pais" value="${na(pii.pais)}" class="shadow-sm border rounded w-full py-2 px-3"></div>
                        
                        <div><label class="text-sm font-medium text-gray-500">Obra Social</label><input id="perfil-os" value="${na(p.obra_social)}" class="shadow-sm border rounded w-full py-2 px-3"></div>
                        <div><label class="text-sm font-medium text-gray-500">N° de Afiliado</label><input id="perfil-afiliado" value="${na(p.numero_afiliado)}" class="shadow-sm border rounded w-full py-2 px-3"></div>
                        <div><label class="text-sm font-medium text-gray-500">Género</label>
                            <select id="perfil-genero" class="shadow-sm border rounded w-full py-2 px-3">
                                <option value="" ${!pii.genero ? 'selected' : ''}>Seleccionar...</option>
                                <option value="M" ${pii.genero === 'M' ? 'selected' : ''}>Masculino</option>
                                <option value="F" ${pii.genero === 'F' ? 'selected' : ''}>Femenino</option>
                                <option value="O" ${pii.genero === 'O' ? 'selected' : ''}>Otro</option>
                            </select>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg"><h4 class="text-sm font-medium text-gray-500">Grupo Sanguíneo</h4><p class="font-semibold">${naView(clinico.grupo_sanguineo)}</p></div>

                        <div class="bg-gray-100 p-3 rounded-lg"><h4 class="text-sm font-medium text-gray-500">Nombre</h4><p class="font-semibold">${naView(pii.nombre)}</p></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><h4 class="text-sm font-medium text-gray-500">DNI</h4><p class="font-semibold">${naView(pii.dni)}</p></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><h4 class="text-sm font-medium text-gray-500">Email</h4><p class="font-semibold">${naView(pii.email)}</p></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><h4 class="text-sm font-medium text-gray-500">Fecha de Nacimiento</h4><p class="font-semibold">${naView(pii.fecha_nac)}</p></div>
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <button id="btn-save-perfil" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Guardar Cambios</button>
                        <button id="btn-cancel-perfil" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">Cancelar</button>
                    </div>
                `;
            } else {
                // --- MODO VISTA (¡CAMPOS AÑADIDOS!) ---
                html = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Mi Perfil</h3>
                        <button id="btn-edit-perfil" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded flex items-center space-x-2">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                            <span>Editar Perfil</span>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Nombre</h4><p class="text-lg font-semibold">${naView(pii.nombre)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">DNI</h4><p class="text-lg font-semibold">${naView(pii.dni)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Fecha de Nacimiento</h4><p class="text-lg font-semibold">${naView(pii.fecha_nac)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Género</h4><p class="text-lg font-semibold">${naView(pii.genero)}</p></div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Email</h4><p class="text-lg font-semibold">${naView(pii.email)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Teléfono</h4><p class="text-lg font-semibold">${naView(pii.telefono, MENSAGES.telefono)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border md:col-span-2"><h4 class="text-sm font-medium text-gray-500">Dirección</h4><p class="text-lg font-semibold">${pii.direccion ? `${pii.direccion} (${naView(pii.pais, MENSAGES.pais)})` : naView(null, MENSAGES.direccion)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Obra Social</h4><p class="text-lg font-semibold">${naView(p.obra_social, MENSAGES.obra_social)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">N° de Afiliado</h4><p class="text-lg font-semibold">${naView(p.numero_afiliado, MENSAGES.numero_afiliado)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Grupo Sanguíneo</h4><p class="text-lg font-semibold">${naView(clinico.grupo_sanguineo, MENSAGES.grupo_sanguineo)}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border"><h4 class="text-sm font-medium text-gray-500">Alergias</h4><p class="text-lg font-semibold">${clinico.alergias?.join(', ') || naView(null, MENSAGES.alergias)}</p></div>
                    </div>
                `;
            }
            document.getElementById('perfil-content').innerHTML = html;
            
            // Re-adjuntar listeners
            if (isEditing) {
                document.getElementById('btn-save-perfil').addEventListener('click', handleSavePerfil);
                document.getElementById('btn-cancel-perfil').addEventListener('click', () => renderPerfil(currentPacientePerfil, false));
            } else {
                document.getElementById('btn-edit-perfil').addEventListener('click', () => renderPerfil(currentPacientePerfil, true));
                lucide.createIcons();
            }
        }
        function renderFormHabito() { /* (Sin cambios) */
            document.getElementById('registrar-content').innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800">Registrar Hábito o Síntoma</h3>
                <form id="form-habito" class="mt-4 space-y-4 max-w-lg">
                    <div><label class="block text-sm font-medium text-gray-700">Tipo de Registro</label><select id="habito-tipo" class="mt-1 block w-full p-2 border rounded-md"><option value="glucosa">Glucosa (mg/dL)</option><option value="presion_sistolica">Presión Sistólica (mmHg)</option><option value="sueño">Horas de Sueño</option><option value="sintoma">Sintoma (Alerta)</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Valor o Descripción</label><input id="habito-valor" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ej: 110 o 'Dolor de cabeza'"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Notas (Opcional)</label><input id="habito-notas" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ej: 'en ayunas'"></div>
                    <button type="submit" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded">Registrar</button>
                    <div id="habito-status" class="text-sm mt-2"></div>
                </form>
            `;
            document.getElementById('form-habito').addEventListener('submit', handleRegistrarHabito);
        }
        function renderHabitos(habitos) { /* (Sin cambios) */
             let html = '<h3 class="text-xl font-semibold text-gray-800">Mis Hábitos Registrados</h3>';
            if (habitos.length === 0) { html += '<p class="mt-4">Aún no has registrado hábitos.</p>'; } else {
                 html += `<table class="min-w-full divide-y divide-gray-200 mt-4 border rounded-lg"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${habitos.map(h => `<tr><td class="px-6 py-4">${new Date(h.ts.$date).toLocaleString()}</td><td class="px-6 py-4">${h.tipo}</td><td class="px-6 py-4">${h.valor} ${h.notas ? `(${h.notas})` : ''}</td></tr>`).join('')}</tbody></table>`;
            }
            document.getElementById('habitos-content').innerHTML = html;
        }
        function renderFormTurno(medicos) { /* (Sin cambios) */
            const optionsHtml = medicos.map(m => {
                const especialidad = m.especialidad || 'General';
                return `<option value="${m._id}" data-especialidad="${especialidad}">${m.nombre} (${especialidad})</option>`;
            }).join('');
            document.getElementById('turnos-content').innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800">Solicitar Turno</h3>
                <form id="form-turno" class="mt-4 space-y-4 max-w-lg">
                    <div><label class="block text-sm font-medium text-gray-700">Médico</label><select id="turno-medico" class="mt-1 block w-full p-2 border rounded-md">
                        ${optionsHtml || '<option value="" disabled>No hay médicos disponibles</option>'}
                    </select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Fecha y Hora</label><input id="turno-ts" type="datetime-local" class="mt-1 block w-full p-2 border rounded-md"></div>
                     <div><label class="block text-sm font-medium text-gray-700">Sede</label><select id="turno-sede" class="mt-1 block w-full p-2 border rounded-md"><option value="Argentina">Argentina</option><option value="Colombia">Colombia</option><option value="Uruguay">Uruguay</option></select></div>
                    <button type="submit" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded">Solicitar Turno</button>
                    <div id="turno-status" class="text-sm mt-2"></div>
                </form>
            `;
            document.getElementById('form-turno').addEventListener('submit', handleSacarTurno);
        }
        function renderMisTurnos(turnos) { /* (Sin cambios) */
            let html = '<h3 class="text-xl font-semibold text-gray-800">Mis Turnos</h3>';
            if (turnos.length === 0) { html += '<p class="mt-4">No tienes turnos registrados.</p>'; } else {
                 html += `<table class="min-w-full divide-y divide-gray-200 mt-4 border rounded-lg"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha y Hora</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Médico</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Especialidad</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acción</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${turnos.map(t => {
                    const estado = t.estado.toUpperCase();
                    const estadoClase = estado === 'PENDIENTE' ? 'text-blue-600' : (estado === 'CANCELADO' || estado === 'NO_ASISTIO' ? 'text-red-600' : 'text-gray-500');
                    const actionButton = estado === 'PENDIENTE'
                        ? `<button data-turno-id="${t._id.$oid || t._id}" class="btn-cancelar-turno bg-red-100 hover:bg-red-200 text-red-700 py-1 px-3 rounded text-xs font-medium">Cancelar</button>`
                        : '';
                    return `<tr><td class="px-6 py-4">${new Date(t.ts.$date).toLocaleString()}</td><td class="px-6 py-4">${t.medico_nombre || 'N/A'}</td><td class="px-6 py-4">${t.especialidad}</td><td class="px-6 py-4 font-semibold ${estadoClase}">${estado}</td><td class="px-6 py-4">${actionButton}</td></tr>`;
                }).join('')}</tbody></table>`;
            }
            document.getElementById('mis-turnos-content').innerHTML = html;
            document.querySelectorAll('.btn-cancelar-turno').forEach(button => {
                button.addEventListener('click', handleCancelarTurno);
            });
            lucide.createIcons();
        }

        // --- (¡ACTUALIZADO!) Handler para Guardar Perfil ---
        async function handleSavePerfil() {
            const statusDiv = document.getElementById('perfil-save-status');
            
            const body = {
                telefono: document.getElementById('perfil-telefono').value || null,
                direccion: document.getElementById('perfil-direccion').value || null,
                pais: document.getElementById('perfil-pais').value || null,
                genero: document.getElementById('perfil-genero').value || null,
                obra_social: document.getElementById('perfil-os').value || null,
                numero_afiliado: document.getElementById('perfil-afiliado').value || null
            };

            showConfirmationModal(
                "¿Guardar Cambios?",
                "¿Estás seguro de que deseas actualizar tu perfil con esta información?",
                async () => { // onConfirm
                    statusDiv.textContent = 'Guardando...';
                    statusDiv.className = 'text-sm my-2 text-gray-500';
                    try {
                        await fetchApi(`${API_URL}/paciente/${currentUser._id}/perfil`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        // ¡Éxito! Refrescar la pestaña de perfil
                        await fetchDataForTab('perfil'); 
                    } catch (error) {
                        statusDiv.textContent = `Error: ${error.message}`;
                        statusDiv.className = 'text-sm my-2 text-red-600';
                    }
                }
            );
        }

        // --- Handlers (con modal) (Sin cambios) ---
        async function handleRegistrarHabito(e) {
            e.preventDefault();
            const tipo = document.getElementById('habito-tipo').value;
            const valor = document.getElementById('habito-valor').value;
            showConfirmationModal(
                "¿Registrar Hábito?",
                `¿Estás seguro de que deseas registrar "${tipo}: ${valor}"?`,
                async () => { 
                    const statusDiv = document.getElementById('habito-status');
                    const notas = document.getElementById('habito-notas').value;
                    let valorParseado = (tipo === 'sintoma') ? valor : parseFloat(valor);
                    if (isNaN(valorParseado) && tipo !== 'sintoma') {
                         statusDiv.textContent = 'El valor debe ser numérico.';
                         statusDiv.className = 'text-sm mt-2 text-red-600';
                         return;
                    }
                    statusDiv.textContent = 'Registrando...';
                    try {
                        await fetchApi(`${API_URL}/habitos`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ "tipo": tipo, "valor": valorParseado, "notas": notas || null })
                        });
                        statusDiv.textContent = `¡Hábito '${tipo}' registrado con éxito!`;
                        statusDiv.className = 'text-sm mt-2 text-green-600';
                        e.target.reset(); 
                    } catch (error) {
                        statusDiv.textContent = `Error: ${error.message}`;
                        statusDiv.className = 'text-sm mt-2 text-red-600';
                    }
                }
            );
        }
        async function handleSacarTurno(e) {
            e.preventDefault();
            const ts = document.getElementById('turno-ts').value;
            const statusDiv = document.getElementById('turno-status');
            if (!ts) {
                statusDiv.textContent = 'Debe seleccionar una fecha y hora.';
                statusDiv.className = 'text-sm mt-2 text-red-600';
                return;
            }
            if (new Date(ts) < new Date()) {
                statusDiv.textContent = 'La fecha y hora del turno no pueden ser anteriores a la actual.';
                statusDiv.className = 'text-sm mt-2 text-red-600';
                return;
            }
            showConfirmationModal(
                "¿Solicitar Turno?",
                `¿Estás seguro de que deseas solicitar este turno para el ${new Date(ts).toLocaleString()}?`,
                async () => {
                    const medico_select = document.getElementById('turno-medico');
                    const medico_id = medico_select.value;
                    const especialidad = medico_select.options[medico_select.selectedIndex].dataset.especialidad;
                    const sede = document.getElementById('turno-sede').value;
                    if (!medico_id) {
                        statusDiv.textContent = 'Debe seleccionar un médico.';
                        statusDiv.className = 'text-sm mt-2 text-red-600';
                        return;
                    }
                    statusDiv.textContent = 'Solicitando...';
                    try {
                        const turno_id = "turno-" + Date.now();
                        await fetchApi(`${API_URL}/turnos`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                "_id": turno_id,
                                "paciente_id": currentUser._id, 
                                "medico_id": medico_id,
                                "ts": new Date(ts).toISOString(),
                                "especialidad": especialidad,
                                "sede": sede
                            })
                        });
                        statusDiv.textContent = `¡Turno solicitado con éxito para ${especialidad}!`;
                        statusDiv.className = 'text-sm mt-2 text-green-600';
                        e.target.reset();
                    } catch (error) {
                        statusDiv.textContent = `Error: ${error.message}`;
                        statusDiv.className = 'text-sm mt-2 text-red-600';
                    }
                }
            );
        }
        async function handleCancelarTurno(event) {
            const turnoId = event.target.dataset.turnoId;
            const boton = event.target;
            showConfirmationModal(
                "¿Confirmar Cancelación?",
                "Estás a punto de cancelar este turno. ¿Estás seguro de que deseas continuar? Esta acción no se puede revertir.",
                async () => {
                    boton.textContent = 'Cancelando...';
                    boton.disabled = true;
                    try {
                        await fetchApi(`${API_URL}/turnos/${turnoId}/cancelar`, {
                            method: 'PATCH'
                        });
                        await fetchDataForTab('mis-turnos');
                    } catch (error) {
                        alert(`Error al cancelar el turno: ${error.message}`);
                        boton.textContent = 'Cancelar';
                        boton.disabled = false;
                        await fetchDataForTab('mis-turnos');
                    }
                }
            );
        }

        // --- Event Listeners (Sin cambios) ---
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        
        logoutButton.addEventListener('click', () => {
            showConfirmationModal(
                "¿Cerrar sesión?",
                "¿Estás seguro de que deseas cerrar tu sesión actual?",
                handleLogout 
            );
        });

        function switchLoginTabs(targetTab) {
            if (targetTab === 'login') {
                loginPane.classList.remove('hidden');
                registerPane.classList.add('hidden');
                tabBtnLogin.classList.add('active');
                tabBtnRegister.classList.remove('active', 'text-gray-500');
                tabBtnRegister.classList.add('text-gray-500');
            } else {
                loginPane.classList.add('hidden');
                registerPane.classList.remove('hidden');
                tabBtnLogin.classList.remove('active');
                tabBtnLogin.classList.add('text-gray-500');
                tabBtnRegister.classList.add('active');
                tabBtnRegister.classList.remove('text-gray-500');
            }
        }
        tabBtnLogin.addEventListener('click', () => switchLoginTabs('login'));
        tabBtnRegister.addEventListener('click', () => switchLoginTabs('register'));

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                tabPanes.forEach(pane => pane.classList.add('hidden'));
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-700', 'text-blue-800');
                    btn.classList.add('text-gray-500');
                });
                document.getElementById(`${targetTab}-content`).classList.remove('hidden');
                button.classList.add('border-blue-700', 'text-blue-800');
                fetchDataForTab(targetTab);
            });
        });

        function initApp() {
            lucide.createIcons();
        }
        initApp();
    </script>
</body>
</html>